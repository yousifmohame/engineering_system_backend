// ./prisma/schema.prisma (الإصدار المصحح v3 - باستخدام Json)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// 2. النماذج (Models) الأساسية للنظام
// ===============================================

// ------ نموذج العميل (شاشة 300) (مُحدث بالكامل) ------
model Client {
  id         String @id @default(cuid())
  clientCode String @unique // كود العميل

  // --- الحقول الفريدة (يجب أن تبقى في المستوى الأعلى) ---
  mobile   String  @unique
  email    String? @unique
  idNumber String  @unique

  // --- استخدام نوع "Json" للكائنات المتداخلة ---
  // هذا يطابق الواجهات (Interfaces) في شاشة v19
  name           Json // (يطابق ClientName)
  contact        Json // (يطابق ClientContact)
  address        Json? // (يطابق ClientAddress)
  identification Json // (يطابق ClientIdentification)

  // --- باقي بيانات شاشة 300 ---
  type                 String // (فرد، شركة، جهة حكومية)
  category             String? // (VIP, مؤسسة, عادي)
  nationality          String?
  occupation           String?
  company              String?
  taxNumber            String?
  rating               Int?    @default(3)
  secretRating         Int?    @default(50)
  grade                String? // (أ, ب, ج)
  gradeScore           Int?
  completionPercentage Float?
  isActive             Boolean @default(true)
  notes                String?
  createdBy            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- العلاقات ---
  transactions Transaction[]
  contracts    Contract[]
  quotations   Quotation[]
  attachments  Attachment[]
  activityLogs ActivityLog[]
  documents    Document[]
}

model Payment {
  id        String   @id @default(cuid())
  amount    Float
  date      DateTime @default(now())
  method    String // (نقدي, شيك, تحويل بنكي, ...)
  reference String? // (رقم الشيك أو التحويل)
  notes     String?

  // ✅ يجب إضافة علاقة بالموظف الذي استلم الدفعة
  receivedBy    Employee @relation("EmployeeToPayment", fields: [receivedById], references: [id])
  receivedById  String

  transaction   Transaction @relation(fields: [transactionId], references: [id])
  transactionId String

  @@index([transactionId])
  @@index([receivedById])
}

model ActivityLog {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  action      String // (إنشاء, تعديل, إضافة دفعة, ...)
  description String
  category    String // (معاملة, دفعة, تعديل بيانات, ...)

  performedBy   Employee @relation("EmployeeToActivityLog", fields: [performedById], references: [id])
  performedById String

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String

  @@index([clientId])
  @@index([performedById])
}

// ------ نموذج إعدادات تصنيف العملاء (لتبويب 300-12) ------
model ClientClassification {
  id          String  @id @default(cuid())
  name        String  @unique
  color       String
  description String?
  isActive    Boolean @default(true)
}

// ------ نموذج إعدادات النظام (لتبويب 300-12) ------
model SystemSettings {
  id String @id @default("singleton") // نضمن وجود سجل واحد فقط

  gradingCriteria Json? // (GradingCriteria)
  gradeThresholds Json? // (GradeThresholds)

  updatedAt DateTime @updatedAt
}

// ===============================================
// (مُعدل ومُصحح) نموذج المعاملة (الكيان الفعلي/House)
// ===============================================
model Transaction {
  id              String @id @default(cuid())
  transactionCode String @unique
  title           String // (هذا هو "عنوان المعاملة" من التبويب 1)

  // --- 1. علاقة بنوع المعاملة (القالب) ---
  transactionType   TransactionType? @relation(fields: [transactionTypeId], references: [id])
  transactionTypeId String?

  // --- 2. الحقول الأساسية (من التبويب 1 و 2) ---
  status      String  @default("Draft")
  statusColor String? @default("#6b7280")
  priority    String? @default("متوسط")
  description String?
  location    String?
  deedNumber  String?

  // --- 3. بيانات منسوخة من القالب (للتتبع) ---
  category    String? // (منسوخ من TransactionType)
  complexity  String? // (منسوخ من TransactionType)
  duration    Int?    // (المدة الفعلية، قد تبدأ بالقيمة الافتراضية)
  progress    Float?  @default(0)

  // --- 4. حقول مالية (فعلية) ---
  totalFees       Float?    @default(0) // (قد يبدأ بالقيمة الافتراضية)
  paidAmount      Float?    @default(0)
  remainingAmount Float?    @default(0)
  fees        Json?   // (TransactionFee[]) الرسوم الفعلية (منسوخة من القالب)

  // --- 5. بيانات موروثة (منسوخة من القالب) ---
  tasks       Task[]   // (هذا هو الموديل Task الحالي، سنقوم بنسخ المهام إليه)
  
  // --- ✅✅✅ هذا هو الإصلاح ✅✅✅ ---
  // (أعدناه إلى علاقة بدلاً من Json)
  documents   Document[] 
  
  authorities String[] // (string[]) الجهات الفعلية
  stages      Json?    // (TransactionStage[]) المراحل الفعلية
  warnings    String[]
  notes       String[]
  requestPurposes Json?
  
  // --- 6. العلاقات ---
  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  project   Project? @relation(fields: [projectId], references: [id])
  projectId Int?

  contract   Contract? @relation(fields: [contractId], references: [id])
  contractId String?

  // --- 7. مرفقات وحركات ---
  attachments Attachment[]
  payments    Payment[]
  
  // --- 8. تواريخ ---
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedDate DateTime?
}

model TransactionType {
  id          String  @id @default(cuid())
  code        String  @unique // كود داخلي (مثال: BLD-PERMIT)
  name        String  @unique // الاسم المعروض (مثال: ترخيص بناء)
  description String? // وصف للنوع
  isActive    Boolean @default(true)

  // --- [إضافات جديدة بناءً على ملفك التجريبي] ---
  category    String? // (licenses, properties, etc.)
  categoryAr  String? // (التراخيص، العقارات)
  duration    Int?    @default(0) // المدة المتوقعة بالأيام
  estimatedCost Float?  @default(0) // التكلفة المتوقعة
  complexity  String? // (simple, medium, complex)

  tasks       Json?   // (TransactionTask[]) المهام الافتراضية
  documents   String[] // (string[]) المستندات المطلوبة
  authorities String[] // (string[]) الجهات ذات العلاقة
  fees        Json?   // (TransactionFee[]) الرسوم الافتراضية
  stages      Json?   // (TransactionStage[]) المراحل الافتراضية
  warnings    String[] // (string[]) تحذيرات
  notes       String[] // (string[]) ملاحظات
  // --- [نهاية الإضافات] ---

  // علاقة عكسية: هذا النوع مُستخدم في أي معاملات
  transactions Transaction[]
}

// ------ نموذج المهمة (شاشة 825) ------
// ------ نموذج المهمة (شاشة 825) ------
// ------ نموذج المهمة (شاشة 825) ------
model Task {
  id          String    @id @default(cuid())
  taskNumber  String?   @unique // <-- أضفنا علامة الاستفهام هنا
  title       String
  description String?
  status      String    @default("Pending")
  dueDate     DateTime?
  
  // --- [الإضافات الجديدة] ---
  priority        String?   @default("medium") // (high, medium, low, urgent)
  progress        Int?      @default(0)
  category        String?
  assignedById    String?   // (ID الموظف الذي أسند المهمة)
  receivedDate    DateTime?
  completedDate   DateTime?
  attachmentsCount Int?      @default(0)
  commentsCount   Int?      @default(0)
  fees            Json?     // (لتخزين كائن الأتعاب)
  // -------------------------

  createdAt   DateTime  @default(now())

  transaction   Transaction @relation(fields: [transactionId], references: [id])
  transactionId String

  assignedTo   Employee? @relation("EmployeeToTask", fields: [assignedToId], references: [id])
  assignedToId String?
  
  @@index([assignedToId]) // [جديد] لتحسين أداء جلب "مهامي"
  @@index([transactionId])
}

// ------ نموذج الموظفين (شاشة 817) ------
model Employee {
  id                String                  @id @default(cuid())
  employeeCode      String                  @unique @default(cuid())
  name              String
  nameEn            String?
  nationalId        String                  @unique
  email             String                  @unique
  phone             String                  @unique
  position          String
  department        String
  hireDate          DateTime
  baseSalary        Float?
  jobLevel          Int?
  type              String                  @default("full-time")
  status            String                  @default("active")
  nationality       String?
  gosiNumber        String?
  iqamaNumber       String?
  performanceRating Float?
  frozenUntil       DateTime?
  frozenReason      String?
  password          String
  refreshToken      String?
  permissionsCount  Int? // ✅ الحقل الجديد
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  attachments       Attachment[]            @relation("EmployeeAttachments")
  attendanceRecords EmployeeAttendance[]
  leaveRequests     EmployeeLeaveRequest[]
  skills            EmployeeSkill[]
  certifications    EmployeeCertification[]
  evaluations       EmployeeEvaluation[]
  promotions        EmployeePromotion[]

  roles               JobRole[]      @relation("EmployeeToJobRole")
  specialPermissions  Permission[]   @relation("EmployeeToSpecialPermission")
  managedProjects     Project[]
  assignedTasks       Task[]         @relation("EmployeeToTask")
  sentMessages        Message[]      @relation("SenderToMessage")
  conversations       Conversation[] @relation("EmployeeToConversation")
  uploadedAttachments Attachment[]
  paymentsReceived    Payment[]     @relation("EmployeeToPayment")
  activitiesPerformed ActivityLog[] @relation("EmployeeToActivityLog")
  ownedDocuments Document[] @relation("OwnedDocuments")
  docPermissions DocumentPermission[] @relation("GrantedPermissions")
  documentActivities DocumentActivity[]
  documentAccess DocumentPermission[]
  createdClassifications DocumentClassification[] @relation("CreatedClassifications")
}

// نموذج لسجل الحضور (لتاب 817-07)
model EmployeeAttendance {
  id       String    @id @default(cuid())
  date     DateTime  @db.Date
  status   String // (Present, Absent, On Leave)
  checkIn  DateTime? @db.Time
  checkOut DateTime? @db.Time
  notes    String?

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String

  @@index([employeeId, date])
}

// نموذج لطلبات الإجازات (لتاب 817-07)
model EmployeeLeaveRequest {
  id        String   @id @default(cuid())
  type      String // (سنوية, مرضية, ...)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  status    String   @default("Pending") // (Pending, Approved, Rejected)
  reason    String?

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String

  @@index([employeeId])
}

// نموذج لمهارات الموظف (لتاب 817-08)
model EmployeeSkill {
  id       String @id @default(cuid())
  category String // (فنية, إدارية, لغات)
  skill    String // (AutoCAD, React, إدارة مشاريع)
  level    String // (مبتدئ, متوسط, خبير)

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId])
}

// نموذج لشهادات الموظف (لتاب 817-08)
model EmployeeCertification {
  id         String    @id @default(cuid())
  name       String // (PMP, شهادة AWS)
  authority  String // (PMI, Amazon)
  issueDate  DateTime  @db.Date
  expiryDate DateTime? @db.Date

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId])
}

// نموذج لتقييمات الموظف (لتاب 817-09)
model EmployeeEvaluation {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  evaluator String // (اسم المُقيّم أو الإدارة)
  rating    Float // (التقييم من 5)
  comments  String?

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId, date])
}

// نموذج لترقيات الموظف (لتاب 817-10)
model EmployeePromotion {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  oldPosition String
  newPosition String
  oldLevel    Int
  newLevel    Int
  notes       String?

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId, date])
}

// ------ نموذج الأدوار الوظيفية (شاشة 903) ------
model JobRole {
  id               String    @id @default(cuid())
  code             String    @unique
  nameAr           String
  nameEn           String?
  description      String?
  responsibilities String[] // ✅ تحويله إلى مصفوفة نصوص
  level            String?
  department       String?
  status           String    @default("active")
  canAssignTasks   Boolean   @default(true)
  allowMultiple    Boolean   @default(true)
  allowMultiRole   Boolean   @default(true)
  order            Int?
  createdDate      DateTime  @default(now())
  lastModified     DateTime  @updatedAt
  modifiedBy       String?
  parentRole       JobRole?  @relation("RoleHierarchy", fields: [parentRoleId], references: [id])
  parentRoleId     String?
  childRoles       JobRole[] @relation("RoleHierarchy")

  employees   Employee[]   @relation("EmployeeToJobRole")
  permissions Permission[] @relation("JobRoleToPermission")
}

// ------ نموذج الصلاحيات (شاشة 902) ------
model Permission {
  id           String     @id @default(cuid())
  code         String     @unique
  name         String
  description  String?
  level        String
  screenId     String?
  screenName   String?
  tabId        String?
  tabName      String?
  actionType   String?
  status       String     @default("active")
  frozenType   String?
  frozenDate   DateTime?
  frozenUntil  DateTime?
  frozenBy     String?
  frozenReason String?
  createdDate  DateTime   @default(now())
  lastModified DateTime   @updatedAt
  modifiedBy   String?
  roles        JobRole[]  @relation("JobRoleToPermission")
  employees    Employee[] @relation("EmployeeToSpecialPermission")

  // --- ✅ الإضافة الجديدة هنا ---
  groups PermissionGroup[] @relation("GroupToPermission")
  // ---------------------------
}

// --- ✅ نموذج جديد بالكامل ---
// ------ نموذج مجموعات الصلاحيات (جديد) ------
model PermissionGroup {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?

  // --- ✅ علاقة Many-to-Many مع الصلاحيات ---
  permissions Permission[] @relation("GroupToPermission")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// ------ نموذج المشروع (طلبك الأصلي) ------
model Project {
  id          Int       @id @default(autoincrement())
  title       String    @unique
  description String?
  status      String    @default("Pending")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  manager     Employee? @relation(fields: [managerId], references: [id])
  managerId   String?

  transactions Transaction[]
}

// ------ نموذج العقد (شاشة 814) ------
model Contract {
  id           String   @id @default(cuid())
  contractCode String   @unique
  title        String
  startDate    DateTime
  endDate      DateTime
  totalValue   Float
  status       String   @default("Active")

  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  transactions Transaction[]
  quotation    Quotation?    @relation(fields: [quotationId], references: [id])
  quotationId  String?       @unique
  attachments  Attachment[]
}

// ------ نموذج عرض السعر (شاشة 815) ------
model Quotation {
  id            String   @id @default(cuid())
  quotationCode String   @unique
  status        String   @default("Pending")
  totalValue    Float
  createdAt     DateTime @default(now())

  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  contract Contract?
}

// ------ نموذج المرفقات (شاشة 901) ------
model Attachment {
  id        String   @id @default(cuid())
  fileName  String
  filePath  String   @unique
  fileType  String
  fileSize  Int
  createdAt DateTime @default(now())

  uploadedBy   Employee @relation(fields: [uploadedById], references: [id])
  uploadedById String

  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  transactionId String?

  contract   Contract? @relation(fields: [contractId], references: [id])
  contractId String?

  client   Client? @relation(fields: [clientId], references: [id])
  clientId String?

  // --- أضف هذا الحقل ---
  employee   Employee? @relation("EmployeeAttachments", fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String?
}

// ------ نماذج المراسلة (للشات) ------
model Conversation {
  id        String   @id @default(cuid())
  name      String?
  createdAt DateTime @default(now())

  participants Employee[] @relation("EmployeeToConversation")
  messages     Message[]
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String

  sender   Employee @relation("SenderToMessage", fields: [senderId], references: [id])
  senderId String
}

// نموذج الوثيقة (يطابق FileItem)
model Document {
  id        String   @id @default(cuid())
  fileNumber String   @unique // رقم الملف
  name      String   // اسم الملف أو المجلد
  type      String   // 'file' أو 'folder'
  extension String?  // امتداد الملف
  size      Int?     // حجم الملف (بالبايت)
  filePath  String?  @unique // المسار الفعلي للملف على الخادم
  
  createdAt DateTime @default(now())
  modifiedAt DateTime @updatedAt
  
  ownerId   String
  owner     Employee @relation("OwnedDocuments", fields: [ownerId], references: [id])
  classificationId String?
  classification   DocumentClassification? @relation(fields: [classificationId], references: [id])
  tags      String[] // وسوم
  version   String   @default("1.0")
  isShared  Boolean  @default(false)
  downloads Int      @default(0)
  views     Int      @default(0)

  // لإدارة هيكلية المجلدات
  path      String   // المسار الافتراضي (e.g., "/Contracts/ProjectX")
  parentId  String?
  parent    Document? @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete:Cascade)
  children  Document[] @relation("FolderHierarchy")

  // ربط اختياري بالمعاملات والعملاء
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  
  clientId  String?
  client    Client? @relation(fields: [clientId], references: [id])

  // علاقات الصلاحيات والأنشطة
  permissions DocumentPermission[]
  activities  DocumentActivity[]
  
  @@index([ownerId])
  @@index([parentId])
  @@index([transactionId])
  @@index([clientId])
  @@index([classificationId])
}

// نموذج صلاحيات الوثيقة (يطابق FilePermission)
model DocumentPermission {
  id        String   @id @default(cuid())
  permissionNumber String @unique @default(cuid())
  
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  userId    String
  user      Employee @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accessLevel String // 'view', 'edit', 'delete', 'admin'
  expiryDate  DateTime?
  
  grantedAt   DateTime @default(now())
  grantedById String
  grantedBy   Employee @relation("GrantedPermissions", fields: [grantedById], references: [id])

  @@unique([documentId, userId]) // لا يمكن إعطاء صلاحيتين لنفس المستخدم على نفس الملف
  @@index([userId])
}

// نموذج أنشطة الوثيقة (يطابق FileActivity)
model DocumentActivity {
  id          String   @id @default(cuid())
  activityNumber String @unique @default(cuid())
  
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  fileName    String   // اسم الملف (للتسجيل السريع)
  action      String   // 'upload', 'download', 'edit', 'delete', 'share', 'view'
  
  userId      String
  user        Employee @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  timestamp   DateTime @default(now())
  ipAddress   String?
  details     String?

  @@index([documentId])
  @@index([userId])
}

// نموذج تصنيفات الوثائق (لتاب 901-04)
model DocumentClassification {
  id          String  @id @default(cuid())
  name        String  @unique // اسم التصنيف (مثال: سري، مخططات، عقود)
  color       String  @default("#6b7280") // لون مميز (tailwind color or hex)
  description String? // وصف اختياري

  createdBy   Employee @relation("CreatedClassifications", fields: [createdById], references: [id])
  createdById String
  createdAt   DateTime @default(now())

  // علاقة بالوثائق
  documents Document[]

  @@index([createdById])
}